---
title: 'Assignment 4: Latin Hyper Cube and Sensitivity Analysis'
author: "Sarah Lam & Katheryn Moya & Sofia Urgoiti"
date: "2023-05-02"
output: html_document
---

# Your task

For a given forest, you will perform a sensitivity analysis of model predictions of conductance. Consider the sensitivity of your estimate to uncertainty in the following parameters and inputs
• height
• kd
• k0
• v

- Windspeeds v are normally distributed with a mean of 250 cm/s with a standard deviation of 30 cm/s.
- For vegetation height assume that height is somewhere between 9.5 and 10.5 m (but any value in that range is equally likely).
- For the kd and k0 parameters you can assume that they are normally distributed with standard deviation of 1% of their default values.

a) Use the Latin hypercube approach to generate parameter values for the 4 parameters
b) Run the atmospheric conductance model for these parameters
c) Plot conductance estimates in a way that accounts for parameter uncertainty
d) Plot conductance estimates against each of your parameters
e) Estimate the Partial Rank Correlation Coefficients
f) Discuss what your results tell you about how aerodynamic conductance? What does it suggest about
what you should focus on if you want to reduce uncertainty in aerodymaic conductance estimates?
Does this tell you anything about the sensitivity of plant water use to climate change?


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(purrr)
library(lhs)
library(sensitivity)
library(here)
```


## A. Latin Hypercube Parameter Generation 

Creating a matrix with random samples for the four parameters in our function to choose quantiles that will full sample parameter space. 

```{r}
# Latin Hypercube generation of parameters 
# set a random seed to make things 'random'
set.seed(1)

# which parameters
pnames = c("v", "height", "k_o", "k_d")

# how many parameters
npar =  length(pnames)
# how many samples
nsample = 100

parm_quant = randomLHS(nsample, npar)
colnames(parm_quant)=pnames
# choose distributions for parameters
# v - normally distributed with a mean of 250 cm/s with a standard deviation of 30 cm/s
# height - somewhere between 9.5 and 10.5 m (but any value in that range is equally likely)
# kd and k0 - normally distributed with standard deviation of 1% of their default values
# use random samples to pick the quantiles

parm = as.data.frame(matrix(nrow=nrow(parm_quant), ncol=ncol(parm_quant)))
colnames(parm) = pnames
# for each parameter pick samples 
# I'm using several examples normal distribution (with 10% standard deviation) and uniform with +- 10%
# in reality I should pick distribution from knowledge about uncertainty in parameters

# to make it easy to change set standard deviation / range variation to a variable
pvar = .010

parm[,"v"] = qnorm(parm_quant[,"v"], mean=2.5, sd=0.3) #convert to meters/s for function
parm[,"height"] = qunif(parm_quant[,"height"], min=9.5, max=10.5) 

# normal distribution 1% sd
parm[,"k_d"] = qnorm(parm_quant[,"k_d"], mean=0.7, sd=0.7*pvar)
parm[,"k_o"] = qnorm(parm_quant[,"k_o"], mean=0.1, sd=0.1*pvar)

head(parm) #creating a data frame of 100 potential parameter values based on the mean and sd of each parameter for sensitivity analysis
```

## B. Running Atmospheris Conductance Model 

The model output is atmospheric conductance in mm/s for a given vegetation type (forest). 

```{r}
source(here("R/Catm.R"))

catm <-  parm %>% pmap(Catm)

head(catm)

#turn results into a data fram 

catm_df <- do.call("rbind", catm) 

catm_parm <- cbind(parm, catm_df)

nrow(catm_df)
```

## C. Plotting Conductance Estimates & Parameter Uncertainty

```{r}
#Sarah
# density of boxplot to visualize all of the output
# 1 plot
```


## D. Plotting Conductance Against Each Parameter
```{r}
#Sofia
# plotted against the parameter 
# four plots 
```


## E. Partial Rank Correlation Coefficients
```{r}
#Katheryn
# combine parameter sets with output

sens_result <- pcc(catm_parm, catm_df)

# see coefficients

sens_result

# efficiently plot them

plot(sens_result)

# try again using rank coefficients

sens_result_rank = pcc(parm, yieldsd$maxyield, rank=TRUE )
sens_result_rank
plot(sens_result_rank)

# R sometimes returns complex lists - to see what you have
str(sens_result)

sens_result$PCC

# plot parameter sensitivity
# a bit tricky but nice way to make it easy to plot all parameters against all values
tmp = cbind.data.frame(catm_sd, catm_parm)
```

## F. Discussion



